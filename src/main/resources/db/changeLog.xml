<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <!-- Countries table (cnt) -->
  <changeSet id="country-ddl" author="kees">
    <createTable tableName="country">
      <column name="id" type="int" autoIncrement="true">
        <constraints primaryKey="true" primaryKeyName="country-pk"/>
      </column>
      <!-- ISO-3166 code -->
      <column name="code" type="CHAR(2)">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="nationality" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addUniqueConstraint
        tableName="country"
        columnNames="code"
        constraintName="cnt-code-u"
    />
  </changeSet>

  <include file="countries-dml.xml" relativeToChangelogFile="true"/>

  <!-- user table (usr) -->
  <changeSet id="user-ddl" author="kees">
    <createTable tableName="user">
      <column name="id" type="int" autoIncrement="true">
        <constraints primaryKey="true" primaryKeyName="user-pk"/>
      </column>
      <column name="version" type="int" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="active" type="boolean" defaultValue="true">
        <constraints nullable="false"/>
      </column>
      <column name="userName" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="email" type="varchar(60)">
        <constraints nullable="false"/>
      </column>
      <column name="createdAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="createdById" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedById" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint
      baseTableName="user"
      baseColumnNames="createdById"
      referencedColumnNames="id"
      referencedTableName="user"
      constraintName="usr-usr-createdBy-fk"
    />
    <addForeignKeyConstraint
      baseTableName="user"
      baseColumnNames="lastModifiedById"
      referencedColumnNames="id"
      referencedTableName="user"
      constraintName="usr-usr-modifiedBy-fk"
    />
    <addUniqueConstraint
        tableName="user"
        columnNames="userName"
        constraintName="usr-userName-u"
    />
  </changeSet>

  <changeSet id="user-dml" author="kees">
    <insert tableName="user">
      <column name="id" value="1" autoIncrement="true"/>
      <column name="userName" value="kees.schotanus" />
      <column name="name" value="Kees Schotanus" />
      <column name="email" value="kees.schotanus@somewhere.nl" />
      <column name="createdById" value="1" />
      <column name="lastModifiedById" value="1"/>
    </insert>
  </changeSet>

  <!-- Nobel prize category table (npc) -->
  <changeSet id="nobel-prize-category-ddl" author="kees">
    <createTable tableName="nobel-prize-category">
      <column name="id" type="int" autoIncrement="true">
        <constraints primaryKey="true"  primaryKeyName="nobel-prize-category-pk"/>
      </column>
      <column name="code" type="varchar(3)">
      </column>
      <column name="description" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addUniqueConstraint
        tableName="nobel-prize-category"
        columnNames="code"
        constraintName="npc-code-u"
    />
  </changeSet>

  <changeSet id="nobel-prize-category-dml" author="kees">
    <insert tableName="nobel-prize-category">
      <column name="code" value="P" />
      <column name="description" value="Physics" />
    </insert>
    <insert tableName="nobel-prize-category">
      <column name="code" value="C" />
      <column name="description" value="Chemistry" />
    </insert>
    <insert tableName="nobel-prize-category">
      <column name="code" value="M" />
      <column name="description" value="Physiology or medicine" />
    </insert>
    <insert tableName="nobel-prize-category">
      <column name="code" value="L" />
      <column name="description" value="Literature" />
    </insert>
    <insert tableName="nobel-prize-category">
      <column name="code" value="PC" />
      <column name="description" value="Peace" />
    </insert>
    <insert tableName="nobel-prize-category">
      <column name="code" value="E" />
      <column name="description" value="Economy" />
    </insert>
  </changeSet>

  <!-- Nobel prize table (np) -->
  <changeSet id="nobel-prize-ddl" author="kees">
    <createTable tableName="nobel-prize">
      <column name="id"  type="int" autoIncrement="true">
        <constraints primaryKey="true"  primaryKeyName="nobel-prize-pk"/>
      </column>
      <column name="version" type="int" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="categoryId" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="year" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="url" type="varchar(1024)"/>
      <column name="createdAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="createdById" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedById" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint
      baseTableName="nobel-prize"
      baseColumnNames="categoryId"
      referencedColumnNames="id"
      referencedTableName="nobel-prize-category"
      constraintName="np-npc-fk"
      onDelete="CASCADE"
    />
    <addForeignKeyConstraint
      baseTableName="user"
      baseColumnNames="createdById"
      referencedColumnNames="id"
      referencedTableName="user"
      constraintName="np-usr-createdBy-fk"
    />
    <addForeignKeyConstraint
      baseTableName="nobel-prize"
      baseColumnNames="lastModifiedById"
      referencedColumnNames="id"
      referencedTableName="user"
      constraintName="np-usr-modifiedBy-fk"
    />
    <addUniqueConstraint
      tableName="nobel-prize"
      columnNames="year, categoryId"
      constraintName="np-year-cat-u"
    />
    <createIndex
        indexName="np-npc-idx"
        tableName="nobel-prize">
      <column name="categoryId"/>
    </createIndex>
  </changeSet>

  <!-- person table (prs) -->
  <changeSet id="person-ddl" author="kees">
    <createTable tableName="person">
      <column  name="id"  type="int" autoIncrement="true">
        <constraints primaryKey="true" primaryKeyName="person-pk"/>
      </column>
      <column name="version" type="int" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="personIdentifier" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="displayName" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="text"/>
      <column name="birthDate" type="date">
        <constraints nullable="false"/>
      </column>
      <column name="birthCountryId" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="deathDate" type="date"/>
      <column name="url" type="varchar(1024)"/>
      <column name="createdAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="createdById" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedById" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint
        baseTableName="person"
        baseColumnNames="birthCountryId"
        referencedColumnNames="id"
        referencedTableName="country"
        constraintName="prs-ctr-fk"
    />
    <addForeignKeyConstraint
        baseTableName="person"
        baseColumnNames="createdById"
        referencedColumnNames="id"
        referencedTableName="user"
        constraintName="prs-usr-createdBy-fk"
    />
    <addForeignKeyConstraint
        baseTableName="person"
        baseColumnNames="lastModifiedById"
        referencedColumnNames="id"
        referencedTableName="user"
        constraintName="prs-usr-modifiedBy-fk"
    />
    <addUniqueConstraint
        tableName="person"
        columnNames="personIdentifier"
        constraintName="prs-personIdentifier-u"
    />
    <createIndex
        indexName="prs-ctr-idx"
        tableName="person">
      <column name="birthCountryId"/>
    </createIndex>
  </changeSet>

  <!--
    Organizations table (org)
    Organizations can only win the peace prize.
  -->
  <changeSet id="organization-ddl" author="kees">
    <createTable tableName="organization">
      <column  name="id"  type="int" autoIncrement="true">
        <constraints primaryKey="true" primaryKeyName="organization-pk"/>
      </column>
      <column name="version" type="int" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="organizationIdentifier" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="text"/>
      <column name="url" type="varchar(1024)"/>
      <column name="createdAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="createdById" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedById" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint
        baseTableName="organization"
        baseColumnNames="createdById"
        referencedColumnNames="id"
        referencedTableName="user"
        constraintName="org-usr-createdBy-fk"
    />
    <addForeignKeyConstraint
        baseTableName="organization"
        baseColumnNames="lastModifiedById"
        referencedColumnNames="id"
        referencedTableName="user"
        constraintName="org-usr-modifiedBy-fk"
    />
    <addUniqueConstraint
        tableName="organization"
        columnNames="organizationIdentifier"
        constraintName="org-organizationIdentifier-u"
    />
  </changeSet>

  <!-- Nobel prize laureate table (npl) -->
  <changeSet id="nobel-prize-laureate-ddl" author="kees">
    <createTable tableName="nobel-prize-laureate">
      <column name="id" type="int" autoIncrement="true">
        <constraints primaryKey="true" primaryKeyName="nobel-prize-laureate-pk"/>
      </column>
      <column name="version" type="int" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="nobelPrizeId" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="personId" type="int">
        <constraints nullable="true"/>
      </column>
      <column name="organizationId" type="int">
        <constraints nullable="true"/>
      </column>
      <column name="description" type="text"/>
      <column name="fractionNominator" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="fractionDenominator" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="createdAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="createdById" type="int">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedAt" type="timestamp with timezone" defaultValueDate="now()">
        <constraints nullable="false"/>
      </column>
      <column name="lastModifiedById" type="int">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint
        baseTableName="nobel-prize-laureate"
        baseColumnNames="nobelPrizeId"
        referencedColumnNames="id"
        referencedTableName="nobel-prize"
        constraintName="npl-np-fk"
    />
    <addForeignKeyConstraint
        baseTableName="nobel-prize-laureate"
        baseColumnNames="personId"
        referencedColumnNames="id"
        referencedTableName="person"
        constraintName="npl-prs-fk"
    />
    <addForeignKeyConstraint
        baseTableName="nobel-prize-laureate"
        baseColumnNames="organizationId"
        referencedColumnNames="id"
        referencedTableName="organization"
        constraintName="npl-org-fk"
    />
    <addForeignKeyConstraint
        baseTableName="nobel-prize-laureate"
        baseColumnNames="createdById"
        referencedColumnNames="id"
        referencedTableName="user"
        constraintName="npl-usr-createdBy-fk"
    />
    <addForeignKeyConstraint
        baseTableName="nobel-prize-laureate"
        baseColumnNames="lastModifiedById"
        referencedColumnNames="id"
        referencedTableName="user"
        constraintName="npl-usr-modifiedBy-fk"
    />
    <!--
      Note: Liquibase uses case-sensitive table/column names when double-quoted.
      The quotes below are necessary to address the existing table/columns.
    -->
    <sql>
      ALTER TABLE "nobel-prize-laureate"
      ADD CONSTRAINT "npl-person-or-org-chk"
      CHECK ("personId" IS NOT NULL OR "organizationId" IS NOT NULL);
    </sql>
    <createIndex
        indexName="npl-np-idx"
        tableName="nobel-prize-laureate">
      <column name="nobelPrizeId"/>
    </createIndex>
    <createIndex
        indexName="npl-prs-idx"
        tableName="nobel-prize-laureate">
      <column name="personId"/>
    </createIndex>
  </changeSet>

</databaseChangeLog>
